<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LoggingAspect.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">inventory-service</a> &gt; <a href="index.source.html" class="el_package">com.example.inventoryservice.infrastructure.aop</a> &gt; <span class="el_source">LoggingAspect.java</span></div><h1>LoggingAspect.java</h1><pre class="source lang-java linenums">package com.example.inventoryservice.infrastructure.aop;

import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.util.Arrays;

@Aspect
@Component
<span class="fc" id="L13">public class LoggingAspect {</span>

<span class="fc" id="L15">    private static final Logger log = LoggerFactory.getLogger(LoggingAspect.class);</span>
    private static final String BASE = &quot;com.example.inventoryservice&quot;;
    private static final int MAX_ARG_LEN = 400;

    /** Capas a incluir **/
    @Pointcut(&quot;within(&quot; + BASE + &quot;.infrastructure.web.controller..*)&quot;)
<span class="nc" id="L21">    public void controllerLayer() {}</span>

    @Pointcut(&quot;within(&quot; + BASE + &quot;.application.service..*)&quot;)
<span class="nc" id="L24">    public void applicationLayer() {}</span>

    @Pointcut(&quot;within(&quot; + BASE + &quot;.infrastructure.persistence.adapter..*)&quot;)
<span class="nc" id="L27">    public void adapterLayer() {}</span>

    @Pointcut(&quot;within(&quot; + BASE + &quot;.infrastructure.persistence.repository..*)&quot;)
<span class="nc" id="L30">    public void repositoryLayer() {}</span>

    /** Capas a excluir **/
    @Pointcut(&quot;within(&quot; + BASE + &quot;.domain..*)&quot;)
<span class="nc" id="L34">    public void domainLayer() {}</span>

    @Pointcut(&quot;within(&quot; + BASE + &quot;.infrastructure..mapper..*)&quot;)
<span class="nc" id="L37">    public void mapperLayer() {}</span>

    /** 3af Punto de corte global  todo el flujo **/
    @Pointcut(&quot;(controllerLayer() || applicationLayer() || adapterLayer() || repositoryLayer()) &amp;&amp; !mapperLayer() &amp;&amp; !domainLayer()&quot;)
<span class="nc" id="L41">    public void appFlow() {}</span>

    /** 01 Un solo Around para todo **/
    @Around(&quot;appFlow()&quot;)
    public Object logAround(ProceedingJoinPoint pjp) throws Throwable {
<span class="nc" id="L46">        String className = pjp.getTarget().getClass().getSimpleName();</span>
<span class="nc" id="L47">        String methodName = pjp.getSignature().getName();</span>
<span class="nc" id="L48">        String args = safeArgs(pjp.getArgs());</span>
<span class="nc" id="L49">        String signature = className + &quot;.&quot; + methodName + &quot;()&quot;;</span>

<span class="nc" id="L51">        log.info(&quot;▶️ Iniciando: {} con args={}&quot;, signature, args);</span>
<span class="nc" id="L52">        long start = System.nanoTime();</span>

        try {
<span class="nc" id="L55">            Object result = pjp.proceed();</span>
<span class="nc" id="L56">            long tookMs = (System.nanoTime() - start) / 1_000_000;</span>

<span class="nc" id="L58">            log.info(&quot;✅ Finalizó: {} ({} ms) → Retorno={}&quot;, signature, tookMs, shorten(result));</span>
<span class="nc" id="L59">            return result;</span>
<span class="nc" id="L60">        } catch (Throwable ex) {</span>
<span class="nc" id="L61">            long tookMs = (System.nanoTime() - start) / 1_000_000;</span>
<span class="nc" id="L62">            log.error(&quot;❌ Error en: {} ({} ms) → {}&quot;, signature, tookMs, ex.getMessage(), ex);</span>
<span class="nc" id="L63">            throw ex;</span>
        }
    }

    /** Helpers para limitar **/
    private String safeArgs(Object[] args) {
<span class="nc bnc" id="L69" title="All 4 branches missed.">        if (args == null || args.length == 0) return &quot;[]&quot;;</span>
<span class="nc" id="L70">        return Arrays.stream(args)</span>
<span class="nc" id="L71">                .map(this::shorten)</span>
<span class="nc" id="L72">                .toList()</span>
<span class="nc" id="L73">                .toString();</span>
    }

    private String shorten(Object o) {
<span class="nc" id="L77">        String s = String.valueOf(o);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        return s.length() &gt; MAX_ARG_LEN ? s.substring(0, MAX_ARG_LEN) + &quot;...(truncated)&quot; : s;</span>
    }
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>